# m3fd train from clip weight
DATA_SET="rgbtvg_m3fd"
IMGSIZE=${IMGSIZE:-224}
BATCHSIZE=${BATCHSIZE:-32}
MODALITY=${MODALITY:-rgbt}
CUDADEVICES=${CUDADEVICES:-0}
NPROC_PER_NODE=$(echo "$CUDADEVICES" | tr ',' '\n' | wc -l | awk '{print $1}')
DIST_CMD=(env CUDA_VISIBLE_DEVICES=$CUDADEVICES python -m torch.distributed.launch --nproc_per_node=$NPROC_PER_NODE --use_env)

DATA_ROOT="../dataset_and_pretrain_model/datasets/VG/image_data"  
SPLIT_ROOT="../dataset_and_pretrain_model/datasets/VG/ref_data_shuffled"  
CLIP_MODEL="../dataset_and_pretrain_model/pretrain_model/pretrained_weights/CLIP/clip_b_ml_cascade_maskrcnn_model_224_peft0111_nolora.pth"  
OUTPUT_DIR_WARMUP="./output_training/HiVG_${IMGSIZE}_${MODALITY}/$DATA_SET/rgbt_finetuning_base_clip_weight/output_v100"
OUTPUT_DIR_STAGE1="./output_training/HiVG_${IMGSIZE}_${MODALITY}/$DATA_SET/rgbt_finetuning_base_clip_weight/output_v101"
OUTPUT_DIR_STAGE2="./output_training/HiVG_${IMGSIZE}_${MODALITY}/$DATA_SET/rgbt_finetuning_base_clip_weight/output_v102"
OUTPUT_DIR_STAGE3="./output_training/HiVG_${IMGSIZE}_${MODALITY}/$DATA_SET/rgbt_finetuning_base_clip_weight/output_v103"

echo -e "\n\n\n\n\n\n\n==================== m3fd warmup ==========================="
# "${DIST_CMD[@]}" --master_port 28872 hivg_train.py --modality $MODALITY --num_workers 4 --epochs 60  --batch_size $BATCHSIZE --lr 0.00025   --lr_scheduler cosine --aug_crop --aug_scale --aug_translate  --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --dataset $DATA_SET      --use_contrastive_loss  --use_rtcc_constrain_loss --use_mask_loss                                       --data_root $DATA_ROOT  --split_root $SPLIT_ROOT  --clip_model $CLIP_MODEL  --output_dir $OUTPUT_DIR_WARMUP --sup_type full;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss --save_hilora_clip --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_WARMUP/best_checkpoint.pth --eval_set val      --output_dir $OUTPUT_DIR_WARMUP;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss --save_hilora_clip --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_WARMUP/best_checkpoint.pth --eval_set test      --output_dir $OUTPUT_DIR_WARMUP;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss --save_hilora_clip --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_WARMUP/best_checkpoint.pth --eval_set testA    --output_dir $OUTPUT_DIR_WARMUP;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss --save_hilora_clip --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_WARMUP/best_checkpoint.pth --eval_set testB    --output_dir $OUTPUT_DIR_WARMUP;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss --save_hilora_clip --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_WARMUP/best_checkpoint.pth --eval_set testC    --output_dir $OUTPUT_DIR_WARMUP;

##
# stage 1
echo -e "\n\n\n\n\n\n\n==================== m3fd stage 1 ==========================="
"${DIST_CMD[@]}" --master_port 28872 hivg_train.py --modality $MODALITY --num_workers 4 --epochs 20  --batch_size $BATCHSIZE --lr 0.00010   --lr_scheduler cosine --aug_crop --aug_scale --aug_translate  --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --dataset $DATA_SET      --use_contrastive_loss  --use_rtcc_constrain_loss --use_mask_loss  --save_hilora_clip --hi_lora_stage 1 --data_root $DATA_ROOT  --split_root $SPLIT_ROOT  --hi_lora_retrain $OUTPUT_DIR_WARMUP/best_checkpoint.pth      --hi_lora_clip $OUTPUT_DIR_WARMUP/clip_lora_stage_with_bridge.pth       --output_dir $OUTPUT_DIR_STAGE1/     --sup_type full;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss  --save_hilora_clip --hi_lora_stage 1 --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_STAGE1/best_checkpoint.pth      --eval_set val    --output_dir $OUTPUT_DIR_STAGE1;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss  --save_hilora_clip --hi_lora_stage 1 --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_STAGE1/best_checkpoint.pth      --eval_set test    --output_dir $OUTPUT_DIR_STAGE1;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss  --save_hilora_clip --hi_lora_stage 1 --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_STAGE1/best_checkpoint.pth      --eval_set testA  --output_dir $OUTPUT_DIR_STAGE1;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss  --save_hilora_clip --hi_lora_stage 1 --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_STAGE1/best_checkpoint.pth      --eval_set testB  --output_dir $OUTPUT_DIR_STAGE1;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss  --save_hilora_clip --hi_lora_stage 1 --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_STAGE1/best_checkpoint.pth      --eval_set testC  --output_dir $OUTPUT_DIR_STAGE1;

#
# stage 2
echo -e "\n\n\n\n\n\n\n==================== m3fd stage 2 ==========================="
"${DIST_CMD[@]}" --master_port 28872 hivg_train.py --modality $MODALITY --num_workers 4 --epochs 20  --batch_size $BATCHSIZE --lr 0.00005   --lr_scheduler cosine --aug_crop --aug_scale --aug_translate  --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --dataset $DATA_SET      --use_contrastive_loss  --use_rtcc_constrain_loss --use_mask_loss  --save_hilora_clip --hi_lora_stage 2 --data_root $DATA_ROOT  --split_root $SPLIT_ROOT  --hi_lora_retrain $OUTPUT_DIR_STAGE1/best_checkpoint.pth      --hi_lora_clip $OUTPUT_DIR_STAGE1/clip_lora_stage_with_bridge.pth       --output_dir $OUTPUT_DIR_STAGE2/     --sup_type full;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss  --save_hilora_clip --hi_lora_stage 2 --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_STAGE2/best_checkpoint.pth      --eval_set val    --output_dir $OUTPUT_DIR_STAGE2;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss  --save_hilora_clip --hi_lora_stage 2 --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_STAGE2/best_checkpoint.pth      --eval_set test    --output_dir $OUTPUT_DIR_STAGE2;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss  --save_hilora_clip --hi_lora_stage 2 --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_STAGE2/best_checkpoint.pth      --eval_set testA  --output_dir $OUTPUT_DIR_STAGE2;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss  --save_hilora_clip --hi_lora_stage 2 --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_STAGE2/best_checkpoint.pth      --eval_set testB  --output_dir $OUTPUT_DIR_STAGE2;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss  --save_hilora_clip --hi_lora_stage 2 --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_STAGE2/best_checkpoint.pth      --eval_set testC  --output_dir $OUTPUT_DIR_STAGE2;

#
# stage 3
echo -e "\n\n\n\n\n\n\n==================== m3fd stage 3 ==========================="
"${DIST_CMD[@]}" --master_port 28872 hivg_train.py --modality $MODALITY --num_workers 4 --epochs 20  --batch_size $BATCHSIZE --lr 0.000025  --lr_scheduler cosine --aug_crop --aug_scale --aug_translate  --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --dataset $DATA_SET      --use_contrastive_loss  --use_rtcc_constrain_loss --use_mask_loss  --save_hilora_clip --hi_lora_stage 3 --data_root $DATA_ROOT  --split_root $SPLIT_ROOT  --hi_lora_retrain $OUTPUT_DIR_STAGE2/best_checkpoint.pth      --hi_lora_clip $OUTPUT_DIR_STAGE2/clip_lora_stage_with_bridge.pth       --output_dir $OUTPUT_DIR_STAGE3/     --sup_type full;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss  --save_hilora_clip --hi_lora_stage 3 --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_STAGE3/best_checkpoint.pth      --eval_set val    --output_dir $OUTPUT_DIR_STAGE3;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss  --save_hilora_clip --hi_lora_stage 3 --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_STAGE3/best_checkpoint.pth      --eval_set test    --output_dir $OUTPUT_DIR_STAGE3;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss  --save_hilora_clip --hi_lora_stage 3 --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_STAGE3/best_checkpoint.pth      --eval_set testA  --output_dir $OUTPUT_DIR_STAGE3;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss  --save_hilora_clip --hi_lora_stage 3 --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_STAGE3/best_checkpoint.pth      --eval_set testB  --output_dir $OUTPUT_DIR_STAGE3;
"${DIST_CMD[@]}" --master_port 28873 hivg_eval.py --modality $MODALITY --num_workers 2 --batch_size $BATCHSIZE  --dataset $DATA_SET           --vl_hidden_dim 512 --imsize $IMGSIZE --max_query_len 77 --normalize_before --enable_adaptive_weights --use_mask_loss  --save_hilora_clip --hi_lora_stage 3 --data_root $DATA_ROOT --split_root $SPLIT_ROOT --eval_model $OUTPUT_DIR_STAGE3/best_checkpoint.pth      --eval_set testC  --output_dir $OUTPUT_DIR_STAGE3;
